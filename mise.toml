min_version = "2025.5.11"

[env]
PROJECT_NAME = "{{ config_root | basename }}"

[tools]
ruby = "{{ get_env(name='RUBY_VERSION', default='3.4.4') }}"
node = "{{ get_env(name='NODE_VERSION', default='24.1.0') }}"
bitwarden-secrets-manager = "latest"

[tasks.docker-compose-up]
description = "Run docker compose up"
run = "docker compose -f dev-docker-compose.yml up -d"

[tasks.docker-compose-down]
description = "Run docker compose down"
run = "docker compose -f dev-docker-compose.yml down"

[tasks."bin:dev"]
description = "Run the development server"
run = "./bin/dev"

[tasks.test]
description = "Run tests using RSpec"
run = "bundle exec rspec"

[tasks.lint]
description = "Run lint using Rubocop"
run = "bundle exec rubocop"

[tasks.dev]
description = "Start development environment (Docker + Rails server) with cleanup on shutdown"
run = '''
#!/bin/bash
set -e

# Colors for pretty output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Cleanup function
cleanup() {
  echo
  echo -e "${YELLOW}ğŸ›‘ Shutting down development environment...${NC}"
  echo -e "${BLUE}ğŸ“¦ Stopping Docker containers...${NC}"
  
  if mise run docker-compose-down; then
    echo -e "${GREEN}âœ… Docker containers stopped successfully!${NC}"
  else
    echo -e "${RED}âŒ Failed to stop Docker containers${NC}"
  fi
  
  echo -e "${PURPLE}ğŸ‘‹ Thanks for coding! See you next time!${NC}"
  echo
  exit 0
}

# Set up trap to call cleanup on SIGINT (Ctrl+C) and SIGTERM
trap cleanup SIGINT SIGTERM

# Welcome banner
echo
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘                ğŸš€ Development Environment ğŸš€             â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

echo -e "${BLUE}ğŸ³ Starting Docker services...${NC}"

# Start docker compose with error handling
if mise run docker-compose-up; then
  echo -e "${GREEN}âœ… Docker services are up and running!${NC}"
else
  echo -e "${RED}âŒ Failed to start Docker services${NC}"
  cleanup
  exit 1
fi

echo
echo -e "${BLUE}ğŸ’ Installing Ruby gems...${NC}"

# Install gems with error handling
if bundle install; then
  echo -e "${GREEN}âœ… Gems installed successfully!${NC}"
else
  echo -e "${RED}âŒ Failed to install gems${NC}"
  cleanup
  exit 1
fi

echo
echo -e "${BLUE}ğŸ” Preparing database...${NC}"
if bundle exec rails db:create db:migrate; then
  echo -e "${GREEN}âœ… Database prepared successfully!${NC}"
else
  echo -e "${RED}âŒ Failed to prepare database${NC}"
  cleanup
  exit 1
fi

echo
echo -e "${YELLOW}âš¡ Starting Rails server...${NC}"
echo -e "${PURPLE}ğŸ’¡ Press Ctrl+C to stop everything and clean up${NC}"
echo

# Start the server (this will block until interrupted)
if mise run bin:dev; then
  echo -e "${GREEN}âœ… Server started successfully!${NC}"
else
  echo -e "${YELLOW}âš ï¸ Server stopped${NC}"
fi

# If server exits normally, also run cleanup
cleanup
'''
